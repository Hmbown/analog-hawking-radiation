name: Stress Testing

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  basic-validation:
    runs-on: ubuntu-latest
    name: Basic Validation
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]

    - name: Run basic horizon finding stress test
      env:
        ANALOG_HAWKING_NO_PLOTS: 1
      run: |
        python -c "
        import numpy as np
        from analog_hawking import find_horizons_with_uncertainty, sound_speed
        
        # Test with various grid sizes
        for nx in [100, 500, 1000, 2000]:
            x = np.linspace(0, 100e-6, nx)
            v = 1.5e6 * np.tanh((x - 50e-6) / 10e-6)
            cs = np.full_like(x, 1e6)
            result = find_horizons_with_uncertainty(x, v, cs)
            print(f'nx={nx}: found {result.positions.size} horizons')
        "

    - name: Test CLI commands
      run: |
        ahr --version
        ahr quickstart --quiet
        ahr validate --quiet
        ahr bench --json

    - name: Validate documentation sync
      run: |
        if [ -f "scripts/doc_sync/render_docs.py" ]; then
          python scripts/doc_sync/render_docs.py \
            --sweep results/gradient_limits_production/gradient_catastrophe_sweep.json || true
        fi
